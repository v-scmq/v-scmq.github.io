import{d as ee,cm as S,p as ce,w as de,c as D,o as O,a as s,b as c,au as Z,cn as ue,e as h,E as te,h as z,co as ve,r as I,n as fe,cp as me,ab as pe,aa as ge,H as X,i as he,cq as ye,cr as Ce,l as we}from"./ldftq50d.js";const Re={class:"col avatar-cover"},be={class:"row center"},ke={class:"s-canvas",ref:"sourceCanvas"},xe={class:"t-canvas",ref:"targetCanvas"},Le=ee({__name:"AvatarCropper",props:{url:{},size:{default:300},cropSize:{default:150}},emits:["error"],setup(y,{expose:k,emit:E}){const C=E,{sin:R,cos:r,floor:U,min:q,PI:V}=Math,n=devicePixelRatio||1,d=new Image,$=S("sourceCanvas"),_=S("targetCanvas"),M=S("cropOverlay");let w=1,o=0,e=0,u=0,v=0,f=0,m,i=!1,P=!1,x;const ae=()=>{y.url&&(d.src=y.url,P=i=!0,d.onload=x,d.onerror=()=>{C("error"),i=!1,x()})},Y=a=>{i&&(w*=a.currentTarget.dataset.i?1.1:.9,x())},j=a=>{i&&(o+=a.currentTarget.dataset.i?15:-15,o<0&&(o+=360),o>=360&&(o-=360),x())},A=a=>{const{clientX:t,clientY:l}=a.touches?a.touches[0]:a;return[t,l]},H=a=>{if(i){m=!0;const[t,l]=A(a);v=t,f=l}},F=a=>{if(m){const[t,l]=A(a);e+=t-v,u+=l-f,v=t,f=l,x()}},G=()=>{m=!1};return k({toURL(a,t){return _.value.toDataURL(a,t)},toBlob(a,t){return new Promise(l=>{_.value.toBlob(l,a,t)})}}),ce(()=>{const a=M.value,t=$.value,l=_.value,p=t.getContext("2d"),W=l.getContext("2d");t.width=y.size*n,t.height=y.size*n,p.scale(n,n),l.width=y.cropSize*n,l.height=y.cropSize*n,x=()=>{const T=t.width/n,N=t.height/n;p.clearRect(0,0,T,N),p.save();const L=10,oe="#e0e0e0",le="#f0f0f0";for(let g=0;g<t.height;g+=L)for(let b=0;b<t.width;b+=L)p.fillStyle=(U(b/L)+U(g/L))%2?oe:le,p.fillRect(b,g,L,L);if(i){P&&(w=q(T*.8/d.width,N*.8/d.height),e=u=o=0,P=!1);let g=o*V/180,b=e,Q=u,re=-d.width*w/2+b*r(g)+Q*R(g),ie=-d.height*w/2-b*R(g)+Q*r(g);p.translate(T/2,N/2),p.rotate(g),p.drawImage(d,re,ie,d.width*w,d.height*w)}p.restore();const J=a.getBoundingClientRect(),K=t.getBoundingClientRect(),se=(J.x-K.x)*n,ne=(J.y-K.y)*n,B=y.cropSize*n;W.clearRect(0,0,l.width,l.height),W.drawImage(t,se,ne,B,B,0,0,B,B)},t.addEventListener("mousedown",H),t.addEventListener("touchstart",H),addEventListener("mousemove",F),addEventListener("touchmove",F),addEventListener("mouseup",G),addEventListener("touchend",G),de(()=>y.url,ae,{immediate:!0})}),(a,t)=>{const l=te,p=ue;return O(),D("div",Re,[s("div",be,[s("div",{class:"s-container",style:Z({width:`${a.size}px`,height:`${a.size}px`})},[s("canvas",ke,null,512),s("div",{class:"crop-overlay",ref:"cropOverlay",style:Z({width:`${a.cropSize}px`,height:`${a.cropSize}px`})},null,4)],4),s("canvas",xe,null,512)]),c(p,{class:"btn-grp"},{default:h(()=>[c(l,{type:"primary",round:"","data-i":"1",onClick:Y},{default:h(()=>t[0]||(t[0]=[z("放大")])),_:1}),c(l,{type:"primary",round:"",onClick:Y},{default:h(()=>t[1]||(t[1]=[z("缩小")])),_:1}),c(l,{type:"primary",round:"",onClick:j},{default:h(()=>t[2]||(t[2]=[z("左转")])),_:1}),c(l,{type:"primary",round:"","data-i":"1",onClick:j},{default:h(()=>t[3]||(t[3]=[z("右转")])),_:1})]),_:1})])}}}),ze={class:"col card-item"},Ee=["src"],Ue={class:"col"},_e={class:"col"},Ve={class:"col"},$e={class:"row"},Ie=ee({__name:"Profile",setup(y){const k=ve(),E=I(null),C=I(""),R=I(!1),r=I({...k.value}),U=S("avatarCropperRef"),{createObjectURL:q,revokeObjectURL:V}=URL,n=fe(()=>{const{avatar:o,name:e,describe:u}=k.value,{avatar:v,name:f,describe:m}=r.value;return o===v&&e===f&&u===m?.trim()}),d=()=>{const o=E.value,e=o.files?.item(0);o.value="",e&&(C.value&&V(C.value),C.value=q(e),R.value=!0)},$=o=>{R.value=!1,C.value&&V(C.value),o.currentTarget.dataset.i&&(r.value.avatar=U.value.toURL())},_=()=>{let{name:o,avatar:e,describe:u}=r.value;const v=[(o=o&&o.trim())?"":"昵称",e?"":"头像",(u=u&&u.trim())?"":"简介"].filter(m=>m);if(v.length>0)return X(`必须设置【${v.join("、")}】`);if(e.length>262144)return X("所选头像文件过大,请重选！");const f={name:o,describe:u,avatar:e};k.value.avatar===e&&delete f.avatar,he(),ye(f).then(({error:m})=>{m||Ce(f),we()})},M=()=>{r.value={...k.value}},w=()=>{X("图片加载失败，请确保是一个支持的文件格式！")};return(o,e)=>{const u=me,v=pe,f=te,m=ge;return O(),D("div",ze,[c(u,{class:"avatar-upload"},{default:h(()=>[s("div",{class:"avatar-cover",onClick:e[0]||(e[0]=i=>E.value.click())},"更换头像"),s("img",{alt:"",src:r.value.avatar},null,8,Ee)]),_:1}),s("div",Ue,[e[4]||(e[4]=s("span",{class:"row mark"},"昵称：",-1)),c(v,{modelValue:r.value.name,"onUpdate:modelValue":e[1]||(e[1]=i=>r.value.name=i)},null,8,["modelValue"])]),s("div",_e,[e[5]||(e[5]=s("span",{class:"row mark"},"邮箱：",-1)),c(v,{"model-value":r.value.email,disabled:""},null,8,["model-value"])]),s("div",Ve,[e[6]||(e[6]=s("span",{class:"row mark"},"简介：",-1)),c(v,{type:"textarea",autosize:{minRows:4,maxRows:10},modelValue:r.value.describe,"onUpdate:modelValue":e[2]||(e[2]=i=>r.value.describe=i)},null,8,["modelValue"])]),s("div",$e,[c(f,{type:"primary",round:"",onClick:_,disabled:n.value},{default:h(()=>e[7]||(e[7]=[z("更新")])),_:1},8,["disabled"]),c(f,{type:"primary",round:"",onClick:M,disabled:n.value},{default:h(()=>e[8]||(e[8]=[z("撤销")])),_:1},8,["disabled"])]),s("input",{hidden:"",type:"file",ref_key:"fileRef",ref:E,accept:"image/*",onChange:d},null,544),c(m,{"align-center":"","destroy-on-close":"","show-close":!1,width:"500",title:"头像裁剪",modelValue:R.value,"onUpdate:modelValue":e[3]||(e[3]=i=>R.value=i)},{header:h(()=>[(O(),D("svg",{class:"icon",viewBox:"0 0 24 24",onClick:$},e[9]||(e[9]=[s("path",{fill:"currentColor",d:"m12 13.4l-4.9 4.9q-.275.275-.7.275t-.7-.275t-.275-.7t.275-.7l4.9-4.9l-4.9-4.9q-.275-.275-.275-.7t.275-.7t.7-.275t.7.275l4.9 4.9l4.9-4.9q.275-.275.7-.275t.7.275t.275.7t-.275.7L13.4 12l4.9 4.9q.275.275.275.7t-.275.7t-.7.275t-.7-.275z"},null,-1)]))),(O(),D("svg",{class:"icon",viewBox:"0 0 24 24","data-i":"1",onClick:$},e[10]||(e[10]=[s("path",{fill:"none",stroke:"currentColor","stroke-width":"2",d:"M5 11l6 6l10 -10"},null,-1)])))]),default:h(()=>[c(Le,{ref_key:"avatarCropperRef",ref:U,url:C.value,onError:w},null,8,["url"])]),_:1},8,["modelValue"])])}}});export{Ie as default};
