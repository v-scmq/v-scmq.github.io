const F=Array,B=F.isArray,j="",P="\r",D=`
`,V=`\r
`,I=",",X="	",z=1<<23,J={stream:!0},_={fatal:!0,ignoreBOM:!0},W=m=>{const d=m.length,n={width:0};for(let s=0;s<d;++s){const e=m[s].charCodeAt(0);if(e>=8203&&e<=8207)continue;const t=e>=65280&&e<=65376||e>=65504&&e<=65510||e>=9312&&e<=9470||e>=12288&&e<=12329||e>=12334&&e<=12351||e>=12352&&e<=12440||e>=12445&&e<=12543||e>=12736&&e<=12783||e>=12784&&e<=12799||e>=12881&&e<=12895||e>=12928&&e<=12937||e>=12938&&e<=13311||e>=13312&&e<=19903||e>=19968&&e<=40959||e>=63744&&e<=64255||e===8288?2:1;n.width+=t,n[n.width]=s+1}return n},q=async(m,d)=>{let n=0,s=[],e=!0;for(;;){let{value:t,done:x}=await m.read();if(t&&(s.push(d.decode(t,J)),n+=t.length),x){s.push(D),e=!1;break}if(n>z){n=0;break}}return{next:e,val:s.join(j)}},Y=m=>m.split(/\r?\n/).filter(d=>d.trim()).map(d=>d.split(/[,\t]/).map(n=>n.trim())),Q=async m=>{let{input:d,columns:n,delimiter:s,quote:e,encoding:t}=m;[I,X].includes(s)||(s=I);let x=0,C=[],a=[],h=-1,o=-1,l=[],y=-1,c=!1,r=!0,$=!0;const T=d.getReader(),b=new TextDecoder(t,_);for(;$;){let{next:w,val:N}=await q(T,b),f=N.length;$=w;for(let i=0;i<f;++i){const u=N[i];if(u===s){if(c){l[++y]=u;continue}l.length?(a[++o]=l.join(j),l=[]):a[++o]=j,r=!0,y=-1;continue}if(u===D||u===void 0){c?l[++y]=u:(a.length||l.length)&&(l.length?(a[++o]=l.join(j),l=[]):a[++o]=j,x=Math.max(x,a.length),y=o=-1,C[++h]=a,a=[],r=!0);continue}if(u!==P){if(u!=='"'){r&&(l[++y]=u);continue}if(c){N[i+1]===u?(l[++y]=u,++i):r=c=!1;continue}y<0&&e?c=!0:l[++y]=u}}}if(!C.length)return{state:0,msg:"无任何数据！"};let g;if(n===!0)g=C.shift().map(w=>({name:w,label:w}));else if(typeof n=="string"){g=[];let[w,N]=Y(n);for(let f=0;f<w.length;++f){let i=w[f]||`field${f+1}`;g[f]={name:i,label:N[f]||i}}}else{let w;g=new F(x).fill(j).map((N,f)=>(w=`field${f+1}`,{name:w,label:w}))}return{data:C.map(w=>{const N={};for(let f=g.length-1;f>=0;--f){const i=g[f],u=w[f];N[i.name]=u.trim()}return N}),columns:g,state:1,msg:"已成功读取CSV数据！"}},Z=m=>{let{data:d,columns:n,wrap:s,delimiter:e,quote:t,dataCol:x}=m;[I,X].includes(e)||(e=I);const C=d.map(l=>n.map(c=>{let r=l[c.name];return typeof r=="number"?r:r?(r=r,t?`"${r.replace(/"/g,'""')}"`:r):j}).join(e)),a=s==="LF"?D:V,h=x?n.map(l=>l.name).join(e):"",o=C.join(a);return new Blob([h,a,o,a])},G=async m=>{let{input:d,columns:n,encoding:s}=m,e=0;if(!n)return{state:e,msg:"必须填写表头信息！"};let t=[],[x,C=t,a=t,h=t]=Y(n),o=[],l=["9","X","N"];for(let i=0;i<x.length;++i){let u=Number(C[i]),S=x[i];if(isNaN(u)||u<1)return{state:e,msg:"宽度配置错误，必须大于0的整数！"};if(!l.includes(S))return{state:e,msg:"列类型必须是【9、X、N】中任意一个！"};let L=a[i]||`field${i+1}`;o[i]={name:L,label:h[i]||L,type:S,width:u}}const y=d.getReader(),c=new TextDecoder(s,_);let r=0,$=-1,T=0,b=o[T],g=[],p={};const w=[];let N=!0,f=!0;for(;N;){let{next:i,val:u}=await q(y,c),S=u.length;N=i;for(let L=0;L<S;++L){let R=u[L],M=b.type==="9";if(R===D){if(f=!0,r<1)continue;let O;if(g.length){let A=g.join(j);O=A.trim(),M&&(!O||isNaN(O=Number(O)))&&(O=null,p[`${b.name}:error`]=`类型转换错误：“原值:${A}; 行:${$}; 列:${T}`),g=[]}else O=M?null:j;p[b.name]=O,w[++$]=p,p={},b=o[T=0],r=0;continue}if(!f||R===P)continue;if(r+=W(R).width,r<b.width){g.push(R);continue}let v;r>b.width?v=[`字符超长错误“字符:${R}; 行:${$}; 位置:${L}; 宽度:${r}”`]:g.push(R);const k=g.join(j);let E=k.trim();M&&(!E||isNaN(E=Number(E)))&&(E=null,v=v||[],v.push(`类型转换错误：“原值:${k}; 行:${$}; 列：:${T}`)),v!=null&&v.length&&(p[`${b.name}:error`]=v.join(D)),p[b.name]=E,b=o[++T],r=0,g=[],b||(w[++$]=p,f=!1,p={},b=o[T=0])}}return{columns:o,data:w,state:1,msg:"已成功读取固定长数据！"}},H=m=>{let{data:d,columns:n,wrap:s}=m;const e=" 　",t=d.map(C=>n.map(h=>{const{name:o,width:l,type:y}=h;let c=C[o];if(c=typeof c=="number"?String(c||0):c||j,y==="9")return c.padStart(l,e[0]).slice(0,l);let r=W(c),{width:$}=r;if($===l)return c;if($>l){let p=r[l];return p===void 0?`${c.slice(0,r[l-1])}${e[0]}`:c.slice(0,p)}let T=[],b=-1,g=y==="X"?0:1;for(;;){let p=Math.random()*10&g;if($+=p===0?1:2,T[++b]=e[$>l?--p:p],$>=l)break}return`${c}${T.join(j)}`}).join(j)),x=s==="LF"?D:V;return new Blob([t.join(x),x])},K=async(m,d)=>{const n=m.getReader(),s=new TextDecoder(d,_);let e=[];for(;;){let{value:h,done:o}=await n.read();if(h&&e.push(s.decode(h,J)),o)break}let t;try{t=JSON.parse(e.join(j))}catch{return{state:0,msg:"读取json失败，这是无效的数据！"}}const{data:x,columns:C}=t,a=[];if(B(x)||a.push("没有任何数据"),B(C)||a.push("没有表格列信息"),a.length)throw t.state=0,a.join(D);return C.forEach((h,o)=>{!h.name&&(h.name=`field${o+1}`),h.label=h.label||h.name}),t.state=1,t.msg="已成功读取json数据！",t};onmessage=async m=>{const d={i0(t){return Q(t)},o0(t){return Z(t)},i1(t){return G(t)},o1(t){return H(t)},i2(t){return K(t.input,t.encoding)},o2(t){return delete t._,new Blob([JSON.stringify(t)])}};let n=m.data,s=n._;s[0]==="i"&&(n.input=n.input.stream());let e=d[s];try{const t=await e(n);postMessage(t)}catch(t){postMessage({state:0,msg:t.message||t})}};
