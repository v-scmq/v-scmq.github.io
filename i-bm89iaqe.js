const U=Array,q=U.isArray,T=null,C=void 0,V="readwrite";let g=T,b=T;const M=()=>b||(g?!0:b=(async()=>{const t="id",e=indexedDB,[{version:a}={}]=await e.databases(),s=!a,n="data",o={a:1,b:1,c:1,d:1};let r=e.open(n,a||1);if(g=await new Promise(i=>{s&&(r.onupgradeneeded=()=>{const f={keyPath:t};for(const w in o)r.result.createObjectStore(w,f)}),r.onsuccess=()=>i(r.result),r.onerror=()=>i(T)}),s||!g)return b=T,!!g;const c=g.objectStoreNames;let d=null;for(let i=c.length-1;i>=0;i-=1){const f=c[i];o[f]?o[f]=2:(d&&d.push(f),!d&&(d=[f]))}const l=Object.keys(o).filter(i=>o[i]<2);return l.length<1?(b=T,!0):(g.close(),r=e.open(n,a+1),g=await new Promise(i=>{r.onupgradeneeded=()=>{const f={keyPath:t},w=r.result;l.forEach(u=>w.createObjectStore(u,f)),d==null||d.forEach(u=>w.deleteObjectStore(u))},r.onsuccess=()=>i(r.result),r.onerror=()=>i(T)}),b=T,!!g)})()),I=async(t,e,a)=>{if(!await M())return[];const s=g.transaction(t),n=s.objectStore(t);if(typeof e=="function"){const i=[],f=new Promise(p=>{s.oncomplete=()=>p(i),s.onerror=()=>p(i)}),w=n.openCursor(),u=e;return w.onsuccess=()=>{const p=w.result;if(p){const{value:E}=p;u(E)&&i.push(E),p.continue()}},await f}const o=q(e),r=e instanceof IDBKeyRange;if(!e||o&&!e.length||r)return await new Promise(i=>{const f=n.getAll(r?e:C,C);f.onsuccess=()=>i(f.result),f.onerror=()=>i([])});const c=o?e:[e],d=new Promise(i=>{s.oncomplete=()=>i(l.filter(Boolean)),s.onerror=()=>i(l)}),l=new U(c.length);return c.forEach((i,f)=>{const w=n.get(i);w.onsuccess=()=>l[f]=w.result}),await d},R=async(t,e,a)=>{if(!await M())return!1;const s=q(e)?e:[e];if(!s.length)return!1;const n=g.transaction(t,V),o=n.objectStore(t),r=new Promise(c=>{n.oncomplete=()=>c(!0),n.onerror=()=>c(!1)});if(a)s.forEach(c=>o.put(c));else{const c=new Date().getTime().toString(36),d=(s.length-1).toString(36).length;s.forEach((l,i)=>{l.id||(l.id=`${c}-${i.toString(36).padStart(d,"0")}`),o.put(l)})}return await r},F=async(t,e)=>{if(!await M())return!1;const a=q(e)?e:[e],s=g.transaction(t,V),n=s.objectStore(t),o=new Promise(r=>{s.oncomplete=()=>r(!0),s.onerror=()=>r(!1)});return a.forEach(r=>n.delete(r)),await o},B=null,x=(1<<22)+2,v="b",P="c",X="a",K="a",z=0,Q=1,ae=3,se=0,D=1,m=2,ee=3,_=4,A=postMessage,te=XMLHttpRequest,h=[];let j,W,k;const ne=t=>{let e;const a=t?Object.keys(t).map(s=>(e=t[s])||e===0?`${s}=${encodeURIComponent(e)}`:0).filter(s=>s).join("&"):"";return a&&`?${a}`},G=()=>navigator.storage.getDirectory(),Y=t=>t.createSyncAccessHandle(),H=async(t,e)=>{(e||await G()).removeEntry(t).catch(()=>B)},re=t=>{let e=1024;if(t<e)return`${t}B`;let a=e;return e=1048576,t<e?`${(t/a).toFixed(2)}KB`:(a=e,e=1073741824,t<e?`${(t/a).toFixed(2)}MB`:`${(t/e).toFixed(2)}GB`)},J=(t,e)=>h.filter(a=>a.type===t&&a.data.state===e),L=t=>{const e=J(t,_),a=ae-e.length;J(t,ee).slice(0,a).forEach(oe)},oe=async t=>{let{type:e,data:a}=t,s=e===z,n=!1;try{await(s?ie(t):le(t))&&(A({k:s?"d":"g",v:a.id}),n=!0)}catch(o){o===m&&(a.state=o,A({k:s?"c":"f",v:{id:a.id,part:a.part,state:a.state,rate:o}})),n=o===D&&a.state===m}finally{if(n){for(let o=h.length-1;o>=0;--o)if(a.id===h[o].data.id){h.splice(o,1);break}await F(s?v:P,a.id)}else await R(s?v:P,a);delete t.http,L(e)}},ie=async t=>{let e=t.data,a=Math.ceil(e.size/x),s=await e.handle.getFile();e.state=_;let n=[...W,{k:"content-type",v:e.type}];for(;e.part<a&&e.state===_;++e.part){let{part:o}=e,r=o*x;await new Promise((c,d)=>{let l=t.http=new te;l.responseType="json",l.upload.onprogress=u=>{e.rate=(u.loaded+r)*100/e.size>>0,A({k:"c",v:{id:e.id,rid:e.rid,part:o,state:e.state,rate:e.rate}})},l.onload=()=>{const u=l.response;u.type==="error"?d(m):(!e.rid&&(e.rid=u.data),c())},l.onerror=()=>d(m),l.onabort=()=>d(D);let i=a<2?s:s.slice(r,r+x),f=i.size,w=e.rid?{id:e.rid,part:o+1,length:f}:{name:e.name,size:e.size,length:f,path:e.path};l.open("post",`${j}/file/upload${ne(w)}`),n.forEach(u=>l.setRequestHeader(u.k,u.v)),l.send(i)}),o<a-1&&e.state!==m&&await R(v,e,!0)}return e.part===a},le=async t=>{let e=t.data,a=Math.ceil(e.size/x),{id:s}=e,n=await G(),o=await n.getFileHandle(s,{create:!0}),r=e.part<a?await Y(o):B;for(e.state=_;e.part<a&&e.state===_;++e.part){let{part:p}=e,E=p*x,O=new Promise((S,$)=>{let y=t.http=new te;y.responseType="arraybuffer",y.onprogress=N=>{e.rate=(N.loaded+E)*100/e.size>>0,A({k:"f",v:{id:e.id,part:p,state:e.state,rate:e.rate}})},y.onload=()=>{y.status===206?S(y.response):$(m)},y.onerror=()=>$(m),y.onabort=()=>$(D),y.open("post",`${j}/file/download`),W.forEach(N=>y.setRequestHeader(N.k,N.v)),y.send(JSON.stringify({id:s,part:p+1}))});try{let S=await O;r.write(S,{at:E}),r.flush(),p<a-1&&e.state!==m&&await R(P,e,!0)}catch(S){throw S===D&&e.state===m&&H(e.id,n),r.close(),S}}if(r&&r.close(),e.part<a)return!1;let c="file",d=e.name||c,l=d.lastIndexOf("."),i=l<0?d:l<1?c:d.slice(0,l),f=l>=0?d.slice(l):"";l=0;for await(let p of k.keys())d===p&&(d=`${i}(${++l})${f}`);let w=!0,u=B;try{r=await Y(o),u=await k.getFileHandle(d,{create:!0}).then(S=>S.createWritable()),await u.truncate(0);let p=1<<23,E=new ArrayBuffer(p),O;for(;(O=r.read(E))>0;)await u.write(O<p?E.slice(0,O):E)}catch{w=!1}finally{u==null||u.close()}return r.close(),w&&await H(s,n),w},Z=(t,e)=>{var s;let a=new Set(t.filter(n=>n.state===D).map(n=>n.id));for(let n=h.length-1;n>=0;--n){let o=h[n],r=o.data;a.has(r.id)&&(r.state=D,(s=o.http)==null||s.abort(),h.splice(n,1))}h.push(...t.filter(n=>n.state===ee).map(n=>({type:e,data:n}))),L(e)},ce={a({auth:t,url:e}){W=t,j=e,Promise.all([I(v),I(P),I(X,a=>a.id===K)]).then(a=>{var s;k=(s=a[2][0])==null?void 0:s.val,A({k:"a",v:a})})},async b(t){let e=new U(t.length),a=-1;for(let s of t){let n=await s.getFile(),o=n.size,r=n.name,c=r.lastIndexOf(".");e[++a]={name:r,part:0,size:o,path:"/",state:se,type:n.type||"application/octet-stream",handle:s,rate:0,_size:re(o),_type:c>0?r.slice(c+1):"unknown"}}await R(v,e),A({k:"b",v:e})},c(t){Z(t,z)},d(t){let e=new Set(t),a=new Set;for(let s=h.length-1;s>=0;--s){let{http:n,data:o}=h[s],{id:r,rid:c}=o;e.has(r)&&(o.state=m,n==null||n.abort(),h.splice(s,1),c&&a.add(c))}a.size>0&&A({k:"d",v:[...a]}),F(v,t),L(z)},e({l:t,d:e}){e&&(k=e,R(X,{id:K,val:e})),R(P,t)},f(t){Z(t,Q)},g(t){let e=new Set(t);for(let a=h.length-1;a>=0;--a){let{http:s,data:n}=h[a];e.has(n.id)&&(n.state=m,s==null||s.abort(),h.splice(a,1))}G().then(a=>t.forEach(s=>H(s,a))),F(P,t),L(Q)}};onmessage=({data:t})=>{ce[t.k](t.v)};
